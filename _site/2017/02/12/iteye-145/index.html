<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>open session in view &mdash; 老实记</title>
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="canonical" href="http://localhost:4000/2017/02/12/iteye-145/">
    <link rel="alternate" type="application/atom+xml" title="老实记" href="http://localhost:4000/feed.xml">
    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    
    <meta property="og:title" content="open session in view">
      
    <meta name="keywords" content="Stone, shidongwa, shidonghua, 石东华">
    <meta name="og:keywords" content="Stone, shidongwa, shidonghua, 石东华">
      
    <meta name="description" content="摘自：http://community.jboss.org/wiki/OpenSessioninView  ">
    <meta name="og:description" content="摘自：http://community.jboss.org/wiki/OpenSessioninView  ">
      
    
    
        
    
    <meta property="og:url" content="http://localhost:4000/2017/02/12/iteye-145/">
    <meta property="og:site_name" content="老实记">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2017-02-12">
    
    <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="http://localhost:4000/assets/js/jquery-ui.js"></script>
    <script type="text/javascript">
    function toggleMenu() {
        var nav = document.getElementsByClassName("site-header-nav")[0];
        if (nav.style.display == "inline-flex") {
          nav.style.display = "none";
        } else {
          nav.style.display = "inline-flex";
        }
    }
    </script>
    <!-- clarity.microsoft -->
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "rxv5n7dp1c");
  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-E5PQNHM9S3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-E5PQNHM9S3');
  </script>
  
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="http://localhost:4000/" title="老实记"><span class="octicon octicon-mark-github"></span> 老实记</a></h1>
            <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <nav class="site-header-nav" role="navigation">
                
                <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="首页">首页</a>
                
                <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="分类">分类</a>
                
                <a href="http://localhost:4000/archives/" class=" site-header-nav-item" target="" title="归档">归档</a>
                
                <a href="http://localhost:4000/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a>
                
                <a href="http://localhost:4000/links/" class=" site-header-nav-item" target="" title="链接">链接</a>
                
                <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="关于">关于</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="open session in">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">open session in view</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2017/02/12
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="http://localhost:4000/categories/#iteye" title="iteye">iteye</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <p>摘自：<a href="http://community.jboss.org/wiki/OpenSessioninView">http://community.jboss.org/wiki/OpenSessioninView</a>  </p>
<p><strong>问题描述</strong></p>
<p>A common issue in a typical (web-)application is the rendering of the view, after the main logic of the action has been completed, and therefore, the Hibernate Session has already been closed and the database transaction has ended. If you access detached objects that have been loaded in the Session inside your JSP (or any other view rendering mechanism), you might hit an unloaded collection or a proxy that isn't initialized. The exception you get is: LazyInitializationException: Session has been closed (or a very similar message).</p>
<p>比如页面是学生信息显示，学生实体对象包含一个课程实体列表，并且采用惰性装载。那么页面显示学生的课程信息时可能Session已关闭，事务已提交，hibernate会抛出上面的异常。基本上问题出现在一次request 与 response 之间layz loading的对象上。</p>
<p>open session in view解决方案也是应用在相应的scope内。如果是用JPA，那么对应Session的是EntityManager，相应的是open entity manager in view. 如果渲染发生在servlet中，在servlet中打开和关闭Session（Session per Request), 这样是没问题的。但如果渲染是用JSP，那么就有这里所说的问题，这时就需要Open Session in View的filter方式。Filter后处理发生在 “渲染JSP模板生成Html” 后， 这时候才关闭Session或者EntityManager  </p>
<p><strong>解决方案</strong></p>
<ol>
<li>为detached objects 重新开一个session  </li>
<li>open session in view in most applications you need the following: when an HTTP request has to be handled, a new Session and database transaction will begin. Right before the response is send to the client, and after all the work has been done, the transaction will be committed, and the Session will be closed. A good standard interceptor in a servlet container is a ServletFilter .</li>
</ol>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HibernateSessionRequestFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Log</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LogFactory</span><span class="o">.</span><span class="na">getLog</span><span class="o">(</span><span class="nc">HibernateSessionRequestFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 
    <span class="kd">private</span> <span class="nc">SessionFactory</span> <span class="n">sf</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span>
                         <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span>
                         <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
 
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Starting a database transaction"</span><span class="o">);</span>
            <span class="n">sf</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">().</span><span class="na">beginTransaction</span><span class="o">();</span>
 
            <span class="c1">// Call the next filter (continue request processing)</span>
            <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
 
            <span class="c1">// Commit and cleanup</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Committing the database transaction"</span><span class="o">);</span>
            <span class="n">sf</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">().</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
 
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">StaleObjectStateException</span> <span class="n">staleEx</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"This interceptor does not implement optimistic concurrency control!"</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Your application will not work until you add compensation actions!"</span><span class="o">);</span>
            <span class="c1">// Rollback, close everything, possibly compensate for any permanent changes</span>
            <span class="c1">// during the conversation, and finally restart business conversation. Maybe</span>
            <span class="c1">// give the user of the application a chance to merge some of his work with</span>
            <span class="c1">// fresh data... what you do here depends on your applications design.</span>
            <span class="k">throw</span> <span class="n">staleEx</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Rollback only</span>
            <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sf</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">().</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">isActive</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Trying to rollback database transaction after exception"</span><span class="o">);</span>
                    <span class="n">sf</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">().</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">rbEx</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Could not rollback transaction after exception!"</span><span class="o">,</span> <span class="n">rbEx</span><span class="o">);</span>
            <span class="o">}</span>
 
            <span class="c1">// Let others handle it... maybe another interceptor for exceptions?</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Initializing filter..."</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Obtaining SessionFactory from static HibernateUtil singleton"</span><span class="o">);</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="nc">HibernateUtil</span><span class="o">.</span><span class="na">getSessionFactory</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{}</span>
 
<span class="o">}</span>
</code></pre></div></div>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>HibernateFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>my.package.HibernateSessionRequestFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>

    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>HibernateFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>   
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ItemDAO</span> <span class="o">{</span>
 
    <span class="nc">Session</span> <span class="n">currentSession</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">ItemDAO</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">currentSession</span> <span class="o">=</span> <span class="nc">HibernateUtil</span><span class="o">.</span><span class="na">getSessionFactory</span><span class="o">().</span><span class="na">getCurrentSession</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="nc">Item</span> <span class="nf">getItemById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">itemId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">Item</span><span class="o">)</span> <span class="n">currentSession</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Item</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">itemId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">String</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">HttpRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
 
    <span class="nc">Long</span> <span class="n">itemId</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="no">ITEM_ID</span><span class="o">);</span>
 
    <span class="nc">ItemDAO</span> <span class="n">dao</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ItemDAO</span><span class="o">();</span>
 
    <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span> <span class="no">RESULT</span><span class="o">,</span> <span class="n">dao</span><span class="o">.</span><span class="na">getItemById</span><span class="o">(</span><span class="n">itemId</span><span class="o">)</span> <span class="o">);</span>
  
    <span class="k">return</span> <span class="s">"success"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p><strong>filter for long conversation 长事务</strong> </p>
<p>If you'd like to use a single Session for several database transactions, you either have to implement it completely yourself, or you have to use the built-in &quot;application managed&quot; strategy:      </p>
<p>To enable the application-managed &quot;current&quot; Session strategy, set your hibernate.current_session_context_class configuration property to org.hibernate.context.ManagedSessionContext (or simply &quot;managed&quot; in Hibernate 3.2). You can now bind and unbind the &quot;current&quot; Session with static methods, and control the FlushMode and flushing manually.  </p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HibernateSessionConversationFilter</span>
        <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Log</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LogFactory</span><span class="o">.</span><span class="na">getLog</span><span class="o">(</span><span class="nc">HibernateSessionConversationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 
    <span class="kd">private</span> <span class="nc">SessionFactory</span> <span class="n">sf</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">HIBERNATE_SESSION_KEY</span> <span class="o">=</span> <span class="s">"hibernateSession"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">END_OF_CONVERSATION_FLAG</span> <span class="o">=</span> <span class="s">"endOfConversation"</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span>
                         <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span>
                         <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
 
        <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">classic</span><span class="o">.</span><span class="na">Session</span> <span class="n">currentSession</span><span class="o">;</span>
 
        <span class="c1">// Try to get a Hibernate Session from the HttpSession</span>
        <span class="nc">HttpSession</span> <span class="n">httpSession</span> <span class="o">=</span>
                <span class="o">((</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">).</span><span class="na">getSession</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">disconnectedSession</span> <span class="o">=</span>
                <span class="o">(</span><span class="nc">Session</span><span class="o">)</span> <span class="n">httpSession</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">HIBERNATE_SESSION_KEY</span><span class="o">);</span>
 
        <span class="k">try</span> <span class="o">{</span>
 
            <span class="c1">// Start a new conversation or in the middle?</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">disconnectedSession</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"&gt;&gt;&gt; New conversation"</span><span class="o">);</span>
                <span class="n">currentSession</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
                <span class="n">currentSession</span><span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="nc">FlushMode</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"&lt; Continuing conversation"</span><span class="o">);</span>
                <span class="n">currentSession</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">classic</span><span class="o">.</span><span class="na">Session</span><span class="o">)</span> <span class="n">disconnectedSession</span><span class="o">;</span>
            <span class="o">}</span>
 
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Binding the current Session"</span><span class="o">);</span>
            <span class="nc">ManagedSessionContext</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">currentSession</span><span class="o">);</span>
 
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Starting a database transaction"</span><span class="o">);</span>
            <span class="n">currentSession</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
 
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Processing the event"</span><span class="o">);</span>
            <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
 
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Unbinding Session after processing"</span><span class="o">);</span>
            <span class="n">currentSession</span> <span class="o">=</span> <span class="nc">ManagedSessionContext</span><span class="o">.</span><span class="na">unbind</span><span class="o">(</span><span class="n">sf</span><span class="o">);</span>
 
            <span class="c1">// End or continue the long-running conversation?</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">END_OF_CONVERSATION_FLAG</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
                <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="no">END_OF_CONVERSATION_FLAG</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Flushing Session"</span><span class="o">);</span>
                <span class="n">currentSession</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Committing the database transaction"</span><span class="o">);</span>
                <span class="n">currentSession</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Closing the Session"</span><span class="o">);</span>
                <span class="n">currentSession</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Cleaning Session from HttpSession"</span><span class="o">);</span>
                <span class="n">httpSession</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="no">HIBERNATE_SESSION_KEY</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"&lt;&lt;&lt; End of conversation"</span><span class="o">);</span>
 
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Committing database transaction"</span><span class="o">);</span>
                <span class="n">currentSession</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Storing Session in the HttpSession"</span><span class="o">);</span>
                <span class="n">httpSession</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="no">HIBERNATE_SESSION_KEY</span><span class="o">,</span> <span class="n">currentSession</span><span class="o">);</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"&gt; Returning to user in conversation"</span><span class="o">);</span>
            <span class="o">}</span>
 
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">StaleObjectStateException</span> <span class="n">staleEx</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"This interceptor does not implement optimistic concurrency control!"</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Your application will not work until you add compensation actions!"</span><span class="o">);</span>
            <span class="c1">// Rollback, close everything, possibly compensate for any permanent changes</span>
            <span class="c1">// during the conversation, and finally restart business conversation. Maybe</span>
            <span class="c1">// give the user of the application a chance to merge some of his work with</span>
            <span class="c1">// fresh data... what you do here depends on your applications design.</span>
            <span class="k">throw</span> <span class="n">staleEx</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Rollback only</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sf</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">().</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">isActive</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Trying to rollback database transaction after exception"</span><span class="o">);</span>
                    <span class="n">sf</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">().</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">rbEx</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Could not rollback transaction after exception!"</span><span class="o">,</span> <span class="n">rbEx</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Cleanup after exception!"</span><span class="o">);</span>
 
                <span class="c1">// Cleanup</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Unbinding Session after exception"</span><span class="o">);</span>
                <span class="n">currentSession</span> <span class="o">=</span> <span class="nc">ManagedSessionContext</span><span class="o">.</span><span class="na">unbind</span><span class="o">(</span><span class="n">sf</span><span class="o">);</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Closing Session after exception"</span><span class="o">);</span>
                <span class="n">currentSession</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
 
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Removing Session from HttpSession"</span><span class="o">);</span>
                <span class="n">httpSession</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="no">HIBERNATE_SESSION_KEY</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
 
            <span class="o">}</span>
 
            <span class="c1">// Let others handle it... maybe another interceptor for exceptions?</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
 
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Initializing filter..."</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Obtaining SessionFactory from static HibernateUtil singleton"</span><span class="o">);</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="nc">HibernateUtil</span><span class="o">.</span><span class="na">getSessionFactory</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{}</span>
 
<span class="o">}</span>
</code></pre></div></div>
<p> </p>

    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      

  

  
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script>
        var gitalk = new Gitalk({
            id: '/2017/02/12/iteye-145/',
            clientID: '2443c55823f977361bae',
            clientSecret: 'ace39b2327a62f955b408d4197ff75fc946c8613',
            repo: 'blog-comments',
            owner: 'shidongwa',
            admin: ['shidongwa'],
            labels: ['gitment'],
            perPage: 10,
        })
        gitalk.render('gitalk-container')
        </script>
  


    </div>
  </div>
  <div class="column one-fourth">
    
<h3>Search</h3>
<div id="site_search">
    <input type="text" id="search_box" placeholder="Search">
</div>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/modules/sidebar-search.css">
<script src="http://localhost:4000/assets/js/simple-jekyll-search.min.js"></script>
<script src="http://localhost:4000/assets/js/search.js"></script>

<script type="text/javascript">
SimpleJekyllSearch({
    searchInput: document.getElementById('search_box'),
    resultsContainer: document.getElementById('search_results'),
    json: 'http://localhost:4000/assets/search_data.json',
    searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
    noResultsText: 'No results found',
    limit: 10,
    fuzzy: false,
    exclude: ['Welcome']
})
</script>

    

    
<h3 class="post-directory-title mobile-hidden">Table of Contents</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>

<script src="http://localhost:4000/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2025
                    <span title="Shi Donghua">Shi Donghua</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="https://github.com/shidongwa/shidongwa.github" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="http://localhost:4000/" title="首页" target="">首页</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/categories/" title="分类" target="">分类</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/archives/" title="归档" target="">归档</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/wiki/" title="维基" target="">维基</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/links/" title="链接" target="">链接</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/about/" title="关于" target="">关于</a>
                </li>
                
                <li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>

        </div>
    </footer>
    <!-- / footer -->
    <script src="http://localhost:4000/assets/vendor/share.js/dist/js/share.min.js"></script>
    <script src="http://localhost:4000/assets/js/geopattern.js"></script>
    <script src="http://localhost:4000/assets/js/prism.js"></script>
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>

    

    

    

    

    
</body>
</html>
